<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assas Calendar Exporter - Installation</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 700px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      header {
        text-align: center;
        margin-bottom: 40px;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .subtitle {
        font-size: 1.2em;
        color: #7f8c8d;
      }

      .installation {
        margin-bottom: 40px;
      }

      .installation h2 {
        font-size: 1.8em;
        margin-bottom: 30px;
        color: #2c3e50;
        text-align: center;
      }

      .step {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 25px;
        border-left: 5px solid #667eea;
      }

      .step-number {
        display: inline-block;
        background: #667eea;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        text-align: center;
        line-height: 35px;
        font-weight: bold;
        margin-right: 10px;
        font-size: 1.2em;
      }

      .step p {
        margin: 10px 0;
        font-size: 1.1em;
      }

      .step strong {
        color: #2c3e50;
      }

      .bookmarklet-button {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 40px;
        font-size: 1.3em;
        font-weight: bold;
        text-decoration: none;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        cursor: grab;
        margin: 20px 0;
        text-align: center;
        min-width: 280px;
      }

      .bookmarklet-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
      }

      .bookmarklet-button:active {
        cursor: grabbing;
        transform: translateY(-1px);
      }

      .button-container {
        text-align: center;
        margin: 25px 0;
      }

      .hint {
        text-align: center;
        font-size: 0.95em;
        color: #7f8c8d;
        margin-top: 10px;
      }

      .step ol {
        margin-left: 20px;
        margin-top: 15px;
      }

      .step li {
        margin: 8px 0;
        font-size: 1.05em;
      }

      .step a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
      }

      .step a:hover {
        text-decoration: underline;
      }

      .step a.bookmarklet-button {
        color: white;
        text-decoration: none;
        font-weight: bold;
      }

      .step a.bookmarklet-button:hover {
        text-decoration: none;
      }

      .help {
        background: #fff3cd;
        border-left: 5px solid #ffc107;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .help h3 {
        margin-bottom: 15px;
        color: #856404;
      }

      .help h4 {
        color: #856404;
      }

      .help ul {
        margin-left: 20px;
        margin-top: 10px;
      }

      .help li {
        margin: 8px 0;
      }

      textarea {
        width: 100%;
        height: 120px;
        margin: 15px 0;
        padding: 12px;
        border: 2px solid #ffc107;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.85em;
        resize: vertical;
      }

      .copy-button {
        background: #ffc107;
        color: #856404;
        border: none;
        padding: 12px 30px;
        font-size: 1em;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .copy-button:hover {
        background: #e0a800;
        transform: translateY(-2px);
      }

      .copy-button:active {
        transform: translateY(0);
      }

      .import {
        background: #e7f3ff;
        border-left: 5px solid #2196f3;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .import h3 {
        margin-bottom: 15px;
        color: #1565c0;
      }

      .import p {
        margin-bottom: 15px;
        color: #333;
      }

      .calendar-links {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
      }

      .calendar-link {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        color: #333;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95em;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 0;
        justify-content: center;
      }

      .calendar-link svg {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
      }

      .calendar-link:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        border-color: #2196f3;
      }

      footer {
        text-align: center;
        padding-top: 30px;
        border-top: 2px solid #e9ecef;
        color: #7f8c8d;
        font-size: 0.95em;
      }

      footer a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 600px) {
        .container {
          padding: 25px;
        }

        h1 {
          font-size: 2em;
        }

        .subtitle {
          font-size: 1em;
        }

        .installation h2 {
          font-size: 1.4em;
          margin-bottom: 20px;
        }

        .bookmarklet-button {
          font-size: 1.1em;
          padding: 18px 30px;
          min-width: 240px;
        }

        .step {
          padding: 20px;
        }

        .calendar-links {
          flex-direction: column;
        }

        .calendar-link {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üìÖ Assas Calendar Exporter</h1>
      </header>

      <main>
        <section class="installation">
          <h2>üì• Installation (30 secondes)</h2>

          <!-- Desktop instructions -->
          <div class="step" id="desktop-instructions">
            <p>
              <span class="step-number">1</span><strong>Fais glisser ce bouton</strong> vers ta
              barre de favoris :
            </p>
            <div class="button-container">
              <a href="#" id="bookmarklet-link" class="bookmarklet-button">
                üìÖ Export Assas Calendar
              </a>
            </div>
            <p class="hint">üëÜ Clique et glisse vers le haut de ton navigateur</p>
          </div>

          <!-- Mobile instructions (hidden by default, shown on mobile) -->
          <div class="step" id="mobile-instructions" style="display: none">
            <p><span class="step-number">1</span><strong>Copie le code :</strong></p>
            <div class="button-container">
              <button
                onclick="copyCode(event)"
                class="bookmarklet-button"
                style="cursor: pointer; border: none"
              >
                üìã Copier le code
              </button>
            </div>
          </div>

          <div class="step" id="mobile-step-2" style="display: none">
            <p><span class="step-number">2</span><strong>Cr√©e un favori :</strong></p>
            <ol style="margin-top: 15px">
              <li>Ajoute cette page en favori (üì§ Partager ‚Üí Favoris)</li>
              <li>Modifie le favori ‚Üí Colle le code dans "URL"</li>
              <li>Renomme-le "üìÖ Export Assas"</li>
            </ol>
          </div>

          <div class="step" id="mobile-step-3" style="display: none">
            <p><span class="step-number">3</span><strong>Utilise-le sur Assas</strong></p>
            <ol style="margin-top: 15px">
              <li>
                Va sur
                <a href="https://celcat-web.u-paris2.fr/calendar/" target="_blank"
                  >ton calendrier</a
                >
              </li>
              <li>Clique sur ton favori "üìÖ Export Assas"</li>
              <li>T√©l√©charge ton .ics et importe-le dans ton calendrier</li>
            </ol>
          </div>

          <div class="step" id="desktop-step-2">
            <p><span class="step-number">2</span><strong>Utilise-le sur Assas</strong></p>
            <ol>
              <li>
                Va sur
                <a href="https://celcat-web.u-paris2.fr/calendar/" target="_blank"
                  >ton calendrier</a
                >
                et connecte-toi
              </li>
              <li>Clique sur ton favori "üìÖ Export Assas Calendar"</li>
              <li>Suis les instructions et t√©l√©charge ton fichier .ics</li>
              <li>Importe-le dans Google Calendar, Apple Calendar ou Outlook</li>
            </ol>
          </div>
        </section>

        <section class="help">
          <h3>‚ùì Le glisser-d√©poser ne marche pas ?</h3>
          <p>Pas de panique ! Voici des alternatives :</p>
          <ul>
            <li>
              <strong>M√©thode 1</strong> : Fais un clic droit sur le bouton ‚Üí "Ajouter aux favoris"
            </li>
            <li><strong>M√©thode 2</strong> : Copie le code manuellement ci-dessous</li>
          </ul>

          <h4 style="margin-top: 20px">üìã Copier le code manuellement</h4>

          <p style="margin-top: 10px">
            Copie ce code, puis cr√©e un nouveau favori et colle-le comme URL :
          </p>
          <textarea readonly id="bookmarklet-code">javascript:(function(){function e(e){return e?e.replace(/[-:]/g,"").replace("T","T"):""}function t(e){return e?e.replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n"):""}function n(e){if(e.length<=75)return e;const t=[];let n=e;for(t.push(n.substring(0,75)),n=n.substring(75);n.length>0;)t.push(" "+n.substring(0,74)),n=n.substring(74);return t.join("\r\n")}function r(){const e=new Date;return`${e.getUTCFullYear()}${String(e.getUTCMonth()+1).padStart(2,"0")}${String(e.getUTCDate()).padStart(2,"0")}T${String(e.getUTCHours()).padStart(2,"0")}${String(e.getUTCMinutes()).padStart(2,"0")}${String(e.getUTCSeconds()).padStart(2,"0")}Z`}function o(e){if(!e)return"";const t={"&#233;":"√©","&#232;":"√®","&#234;":"√™","&#224;":"√†","&#226;":"√¢","&#231;":"√ß","&#244;":"√¥","&#249;":"√π","&#251;":"√ª","&#239;":"√Ø","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};let n=e;for(const[e,r]of Object.entries(t))n=n.replace(new RegExp(e,"g"),r);return n}function s(e){if(!e)return"";return{"Cours magistral":"CM","Travaux dirig√©s":"TD","Travaux pratiques":"TP","Conf√©rence":"Conf","S√©minaire":"S√©m",Examen:"Exam"}[e]||e}function a(e){if(!e)return e;const t=e.match(/^(\d+)/);return t?t[1]:e.toUpperCase().includes("OPTION")?"OPTION":e.trim()}function parseDescription(e){if(!e)return{category:null,module:null,staff:null,group:null,room:null};let t=e.replace(/<br\s*\/?>/gi,"\n").replace(/\r\n/g,"\n").replace(/\r/g,"\n");t=o(t);const n=t.split("\n").map(e=>e.trim()).filter(e=>e.length>0),r={category:null,module:null,staff:null,group:null,room:null};if(0===n.length)return r;r.category=n[0],n.length>1&&(r.module=n[1]);const s=/^Salle\s+(.+)$/i,l=/^Groupe\s+(.+)$/i,c=/^([A-Z√Ä-√ñ][A-Z√Ä-√ñ\s-]+),\s*([A-Z√Ä-√ña-z√†-√∂][a-z√†-√∂\s-]+)$/,i=/(.+?)\s*-\s*Groupe\s+(\d+)/i;for(let e=2;e<n.length;e++){const t=n[e],o=t.match(s);if(o){r.room=o[1].trim();continue}const u=t.match(i);if(u){r.staff||(r.staff=u[1].trim()),r.group||(r.group=u[2].trim());continue}const d=t.match(l);if(d){const e=a(d[1].trim());r.group=e;continue}t.match(c)?r.staff=t.trim():/^[A-Z√Ä-√ña-z√†-√∂\s-]+$/.test(t)&&(t===t.toUpperCase()||t.length<15?r.group||(r.group=t.trim()):r.staff||(r.staff=t.trim()))}return r}function l(e,t){const n=[];return e.module&&n.push(`Module: ${e.module}`),e.staff&&n.push(`Intervenant: ${e.staff}`),e.group&&n.push(`Groupe: ${e.group}`),e.room&&n.push(`Salle: ${e.room}`),t.department&&n.push(`D√©partement: ${t.department}`),t.modules&&t.modules.length>0&&n.push(`Code: ${t.modules.join(", ")}`),n.join("\n")}function generateIcs(e){const t=[];t.push("BEGIN:VCALENDAR"),t.push("VERSION:2.0"),t.push("PRODID:-//Assas//Calendar Exporter//EN"),t.push("CALSCALE:GREGORIAN"),t.push("METHOD:PUBLISH"),t.push("X-WR-CALNAME:Assas Calendar"),t.push("X-WR-TIMEZONE:Europe/Paris");for(const n of e){const e=c(n);t.push(e)}return t.push("END:VCALENDAR"),t.join("\r\n")}function c(o){const a=[];a.push("BEGIN:VEVENT");const c=t(o.id);a.push(n(`UID:${c}`)),a.push(`DTSTAMP:${r()}`);const i=e(o.start);a.push(`DTSTART:${i}`);const u=e(o.end);a.push(`DTEND:${u}`);const d=s(o.eventCategory)||"Cours";let p=d;o.parsed&&o.parsed.module&&(p=`${d} - ${o.parsed.module}`);const f=t(p);a.push(n(`SUMMARY:${f}`));const g=t(l(o.parsed||{},o));a.push(n(`DESCRIPTION:${g}`));let m="";if(o.parsed&&o.parsed.room?m=o.parsed.room:o.sites&&o.sites.length>0&&(m=o.sites.join(", ")),m){const e=t(m);a.push(n(`LOCATION:${e}`))}if(o.eventCategory){const e=t(o.eventCategory);a.push(n(`CATEGORIES:${e}`))}return a.push("STATUS:CONFIRMED"),a.push("TRANSP:OPAQUE"),a.push("END:VEVENT"),a.join("\r\n")}function extractStudentId(){try{const e=document.querySelector(".logInOrOut");if(e){const t=e.querySelector(".small");if(t&&t.textContent){const e=t.textContent.trim().match(/\d+/);if(e)return console.log("[Assas Exporter] Found student ID in navbar:",e[0]),e[0]}}}catch(e){console.log("[Assas Exporter] Could not extract from navbar:",e)}try{const e=document.querySelectorAll("*");for(const t of e){const e=(t.textContent||"").match(/[-\s](\d{7})/);if(e)return console.log("[Assas Exporter] Found student ID in DOM:",e[1]),e[1]}}catch(e){console.log("[Assas Exporter] Could not scan DOM:",e)}const e=window.location.href,t=e.match(/federationIds(?:%5B%5D|\[\])=([^&]+)/);if(t)return console.log("[Assas Exporter] Found student ID in query params:",t[1]),t[1];const n=e.match(/#.*federationIds(?:%5B%5D|\[\])=([^&]+)/);if(n)return console.log("[Assas Exporter] Found student ID in hash fragment:",n[1]),n[1];const r=e.match(/[?&]id=([^&]+)/);if(r)return console.log("[Assas Exporter] Found student ID in id param:",r[1]),r[1];const o=e.match(/\/student\/(\d+)/);return o?(console.log("[Assas Exporter] Found student ID in path:",o[1]),o[1]):(console.log("[Assas Exporter] Could not extract student ID automatically"),null)}function promptDateRange(){const e=new Date,t=e.getFullYear(),n=e.getMonth()+1>=9?t:t-1,r=`${n}-09-01`,o=`${n+1}-08-31`,s=new Date(r),a=new Date(o),l=`${s.getDate()} ${i(s.getMonth())} ${s.getFullYear()}`,c=`${a.getDate()} ${i(a.getMonth())} ${a.getFullYear()}`,u=prompt(`üìÖ DATE DE D√âBUT\n\nFormat : ANN√âE-MOIS-JOUR (YYYY-MM-DD)\n\nExemple : (${l}) ‚Üí ${r}\nExemple : (8 juin 2025) ‚Üí 2025-06-08\n\nEntre la date de d√©but :`,r);if(!u)return null;const d=prompt(`üìÖ DATE DE FIN\n\nFormat : ANN√âE-MOIS-JOUR (YYYY-MM-DD)\n\nExemple : (${c}) ‚Üí ${o}\nExemple : (31 ao√ªt 2026) ‚Üí 2026-08-31\n\nEntre la date de fin :`,o);return d?/^\d{4}-\d{2}-\d{2}$/.test(u)&&/^\d{4}-\d{2}-\d{2}$/.test(d)?{startDate:u,endDate:d}:(alert("‚ùå Format de date invalide !\n\nUtilise le format : ANN√âE-MOIS-JOUR\nExemple : 2025-09-01 pour le 1er septembre 2025"),null):null}function i(e){return["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][e]}async function u(e){const t=new URLSearchParams({"federationIds[]":e,resType:"104"});try{const e=await fetch("https://celcat-web.u-paris2.fr/calendar/Home/LoadDisplayNames",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString(),credentials:"include"});if(!e.ok)return console.log("[Assas Exporter] Could not fetch student name"),null;const n=await e.json();if(n&&n.length>0&&n[0].displayName){const e=n[0].displayName.split(",");if(e.length>=2){const t=e[1].trim();return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}}}catch(e){console.log("[Assas Exporter] Error fetching student name:",e)}return null}async function fetchCalendarData(e,t,n){const r=new URLSearchParams({start:t,end:n,resType:"104",calView:"agendaDay","federationIds[]":e});console.log("[Assas Exporter] Fetching calendar data...",{studentId:e,startDate:t,endDate:n});const o=await fetch("https://celcat-web.u-paris2.fr/calendar/Home/GetCalendarData",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString(),credentials:"include"});if(!o.ok)throw new Error(`Erreur API: ${o.status} ${o.statusText}`);const s=await o.json();return console.log("[Assas Exporter] Fetched events:",s.length),s}function d(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||navigator.maxTouchPoints&&navigator.maxTouchPoints>2}async function downloadIcsFile(e,t="assas-calendar.ics"){const n=new Blob([e],{type:"text/calendar;charset=utf-8"});if(d()&&navigator.share&&navigator.canShare)try{const e=new File([n],t,{type:"text/calendar;charset=utf-8"});if(navigator.canShare({files:[e]}))return await navigator.share({files:[e],title:"Calendrier Assas",text:"Importer dans ton calendrier"}),console.log("[Assas Exporter] File shared successfully"),void showStatus("üìÖ Fichier partag√© ! Choisis ton app calendrier","success")}catch(e){"AbortError"===e.name?(console.log("[Assas Exporter] User cancelled share, falling back to download"),showStatus("üì• T√©l√©chargement du fichier...","info")):console.log("[Assas Exporter] Share failed, falling back to download:",e)}const r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(r),100),console.log("[Assas Exporter] File download triggered:",t)}function showStatus(e,t="info"){const n={info:"#2196f3",success:"#4caf50",error:"#f44336"},r=document.createElement("div");r.textContent=e,r.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 15px 20px;\n    background: ${n[t]||n.info};\n    color: white;\n    border-radius: 4px;\n    z-index: 999999;\n    font-family: sans-serif;\n    font-size: 14px;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n    max-width: 300px;\n  `,document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},3e3)}"undefined"!=typeof module&&module.exports,"undefined"!=typeof module&&module.exports,async function(){"use strict";try{console.log("[Assas Exporter] Starting calendar export..."),showStatus("Recherche de ton ID...","info");let e=extractStudentId();if(!e){if(e=prompt("üéì ID √âTUDIANT\n\nTon ID n'a pas pu √™tre d√©tect√© automatiquement.\n\nO√π le trouver ?\n‚Ä¢ En haut √† droite de la page CELCAT\n‚Ä¢ √Ä c√¥t√© de \"Log Out\" (exemple: - 2401012)\n‚Ä¢ C'est un nombre √† 7 chiffres\n\nEntre ton ID √©tudiant :",""),!e||!e.trim())return void showStatus("Export annul√©","error");e=e.trim()}console.log("[Assas Exporter] Using student ID:",e);let t=null;try{t=await u(e),t&&(console.log("[Assas Exporter] Hello",t+"!"),showStatus(`Salut ${t} ! üëã`,"success"),await new Promise(e=>setTimeout(e,1500)))}catch(e){console.log("[Assas Exporter] Could not fetch name:",e)}const n=t||"";showStatus(n?`OK ${n}, choisis tes dates...`:"Choisis tes dates...","info");const r=promptDateRange();if(!r)return void showStatus("Export annul√©","error");const{startDate:o,endDate:s}=r;let a;console.log("[Assas Exporter] Date range:",o,"to",s),showStatus(n?`R√©cup de ton planning ${n}...`:"R√©cup√©ration du planning...","info");try{a=await fetchCalendarData(e,o,s)}catch(e){return console.error("[Assas Exporter] API Error:",e),void showStatus(`Erreur API: ${e.message}`,"error")}if(!a||0===a.length)return void showStatus("Aucun √©v√©nement trouv√© pour cette p√©riode ü§î","error");console.log(`[Assas Exporter] Fetched ${a.length} events`),showStatus(`Analyse de ${a.length} √©v√©nements...`,"info");const l=a.map(e=>({...e,parsed:parseDescription(e.description)}));let c;console.log(`[Assas Exporter] Processing ${l.length} events`),showStatus("G√©n√©ration du fichier...","info");try{c=generateIcs(l)}catch(e){return console.error("[Assas Exporter] ICS Generation Error:",e),void showStatus(`Erreur: ${e.message}`,"error")}const i=`assas-calendar-${o}-${s}.ics`;await downloadIcsFile(c,i);const d=l.length;showStatus(n?`C'est bon ${n} ! ${d} cours export√©s üéâ`:`‚úì ${d} cours export√©s üéâ`,"success"),console.log("[Assas Exporter] Export completed successfully!"),console.log(`[Assas Exporter] File: ${i}`),console.log(`[Assas Exporter] Events: ${d}`)}catch(e){console.error("[Assas Exporter] Unexpected error:",e),showStatus(`Erreur: ${e.message}`,"error")}}();})();</textarea>
          <button class="copy-button" onclick="copyCode(event)">üìã Copier le code</button>
        </section>

        <section class="import">
          <h3>üìÜ Importer ton fichier .ics</h3>

          <!-- Message desktop -->
          <p id="import-desktop-text">Une fois ton fichier t√©l√©charg√©, importe-le dans ton calendrier :</p>

          <!-- Message mobile (masqu√© par d√©faut) -->
          <p id="import-mobile-text" style="display: none">
            Une fois le fichier t√©l√©charg√© ou partag√©, <strong>clique dessus</strong> pour l'ouvrir
            automatiquement dans ton application calendrier par d√©faut ! üéâ
          </p>

          <!-- Liens calendriers (masqu√©s sur mobile) -->
          <div class="calendar-links" id="calendar-links">
            <a
              href="https://calendar.google.com/calendar/u/0/r/settings/export"
              target="_blank"
              class="calendar-link"
            >
              <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <path
                  fill="#FFFFFF"
                  d="M148.882,43.618l-47.368-5.263l-57.895,5.263L38.355,96.25l5.263,52.632l52.632,6.579l52.632-6.579l5.263-53.947L148.882,43.618z"
                />
                <path
                  fill="#1A73E8"
                  d="M65.211,125.276c-3.934-2.658-6.658-6.539-8.145-11.671l9.132-3.763c0.829,3.158,2.276,5.605,4.342,7.342c2.053,1.737,4.553,2.592,7.474,2.592c2.987,0,5.553-0.908,7.697-2.724s3.224-4.132,3.224-6.934c0-2.868-1.132-5.211-3.395-7.026s-5.105-2.724-8.5-2.724h-5.276v-9.039H76.5c2.921,0,5.382-0.789,7.382-2.368c2-1.579,3-3.737,3-6.487c0-2.447-0.895-4.395-2.684-5.855s-4.053-2.197-6.803-2.197c-2.684,0-4.816,0.711-6.395,2.145s-2.724,3.197-3.447,5.276l-9.039-3.763c1.197-3.395,3.395-6.395,6.618-8.987c3.224-2.592,7.342-3.895,12.342-3.895c3.697,0,7.026,0.711,9.974,2.145c2.947,1.434,5.263,3.421,6.934,5.947c1.671,2.539,2.5,5.382,2.5,8.539c0,3.224-0.776,5.947-2.329,8.184c-1.553,2.237-3.461,3.947-5.724,5.145v0.539c2.987,1.25,5.421,3.158,7.342,5.724c1.908,2.566,2.868,5.632,2.868,9.211s-0.908,6.776-2.724,9.579c-1.816,2.803-4.329,5.013-7.513,6.618c-3.197,1.605-6.789,2.421-10.776,2.421C73.408,129.263,69.145,127.934,65.211,125.276z"
                />
                <path
                  fill="#1A73E8"
                  d="M121.25,79.961l-9.974,7.25l-5.013-7.605l17.987-12.974h6.895v61.197h-9.895L121.25,79.961z"
                />
                <path
                  fill="#EA4335"
                  d="M148.882,196.25l47.368-47.368l-23.684-10.526l-23.684,10.526l-10.526,23.684L148.882,196.25z"
                />
                <path
                  fill="#34A853"
                  d="M33.092,172.566l10.526,23.684h105.263v-47.368H43.618L33.092,172.566z"
                />
                <path
                  fill="#4285F4"
                  d="M12.039-3.75C3.316-3.75-3.75,3.316-3.75,12.039v136.842l23.684,10.526l23.684-10.526V43.618h105.263l10.526-23.684L148.882-3.75H12.039z"
                />
                <path
                  fill="#188038"
                  d="M-3.75,148.882v31.579c0,8.724,7.066,15.789,15.789,15.789h31.579v-47.368H-3.75z"
                />
                <path
                  fill="#FBBC04"
                  d="M148.882,43.618v105.263h47.368V43.618l-23.684-10.526L148.882,43.618z"
                />
                <path
                  fill="#1967D2"
                  d="M196.25,43.618V12.039c0-8.724-7.066-15.789-15.789-15.789h-31.579v47.368H196.25z"
                />
              </svg>
              <span>Google</span>
            </a>
            <a
              href="https://outlook.live.com/calendar/0/action/compose"
              target="_blank"
              class="calendar-link"
            >
              <svg viewBox="0 0 1831 1703" xmlns="http://www.w3.org/2000/svg">
                <path
                  fill="#0A2767"
                  d="M1831,894c0-14-7-28-20-35l-634-376c-3-2-6-4-9-5c-24-13-54-13-78,0c-3,2-6,3-9,5L447,859l-1,0c-19,12-25,38-13,57c4,6,8,10,14,14l634,376c3,2,6,4,9,5c24,13,54,13,78,0c3-2,6-3,9-5l634-376C1823,923,1831,909,1831,894z"
                />
                <path
                  fill="#0364B8"
                  d="M520,643h416v382H520V643z M1746,256V81c1-44-34-80-77-81H588c-44,1-78,37-77,81v175l639,170L1746,256z"
                />
                <path fill="#0078D4" d="M511,256h426v383H511V256z" />
                <path fill="#28A8EA" d="M1363,256H937v383l426,383h383V639L1363,256z" />
                <path fill="#0078D4" d="M937,639h426v383H937V639z" />
                <path fill="#0364B8" d="M937,1022h426v383H937V1022z" />
                <path fill="#14447D" d="M520,1025h416v347H520V1025z" />
                <path fill="#0078D4" d="M1363,1022h383v383h-383V1022z" />
                <path
                  fill="#1490DF"
                  d="M1812,928l-1,0l-634,357c-3,2-6,3-9,5c-25,12-53,12-78,0c-3-1-6-3-9-5L447,928l-1,0c-12-7-20-19-20-33v722c0,48,40,87,88,87h1230c48,0,87-39,88-87V894C1831,908,1824,921,1812,928z"
                />
                <path
                  fill="#28A8EA"
                  d="M515,1703h1228c19,0,37-6,53-17l-697-408c-3-1-6-3-9-5L447,906h0l-21-12v720C426,1663,466,1703,515,1703z"
                />
                <defs>
                  <linearGradient id="g1" x1="162" y1="322" x2="774" y2="1381">
                    <stop offset="0" stop-color="#1784D9" />
                    <stop offset="0.5" stop-color="#107AD5" />
                    <stop offset="1" stop-color="#0A63C9" />
                  </linearGradient>
                </defs>
                <path
                  fill="url(#g1)"
                  d="M78,383h781c43,0,78,35,78,78v781c0,43-35,78-78,78H78c-43,0-78-35-78-78V461C0,418,35,383,78,383z"
                />
                <path
                  fill="#FFFFFF"
                  d="M244,711c19-41,50-75,89-98c43-25,92-37,142-36c46-1,91,11,131,34c37,22,68,55,87,94c21,43,31,91,30,138c1,50-10,100-31,145c-20,40-51,74-89,97c-41,24-88,36-136,35c-47,1-93-11-134-34c-38-22-68-55-88-94c-21-42-32-89-31-137C213,805,223,756,244,711z M339,942c10,26,28,48,50,65c23,16,50,24,78,24c30,1,59-7,84-24c22-16,39-39,49-65c11-29,16-60,16-90c0-31-5-62-15-92c-9-27-25-50-47-68c-24-18-53-27-83-26c-29-1-57,8-80,24c-23,16-41,39-51,65c-23,60-23,127,0,187z"
                />
                <path fill="#50D9FF" d="M1363,256h383v383h-383V256z" />
              </svg>
              <span>Outlook</span>
            </a>
            <a
              href="https://support.apple.com/fr-fr/guide/calendar/icl1023/mac"
              target="_blank"
              class="calendar-link"
            >
              <svg viewBox="0 0 2160 2160" xmlns="http://www.w3.org/2000/svg">
                <path
                  fill="#FFFFFF"
                  d="M2160,676c0-26,0-52,0-77c0-22,0-44-1-65c-1-47-4-95-13-142c-8-48-23-92-44-135c-22-42-50-81-83-115c-34-34-72-62-115-83c-43-22-87-36-135-44c-47-8-95-11-142-13c-22-1-44-1-65-1C1536,0,1510,0,1484,0H676c-26,0-52,0-77,0c-22,0-44,0-65,1c-47,1-95,4-142,13c-48,8-92,23-135,44c-42,22-81,50-115,83c-34,34-62,72-83,115c-22,43-36,87-44,135c-8,47-11,95-13,142c-1,22-1,44-1,65c0,26,0,52,0,77v809c0,26,0,52,0,77c0,22,0,44,1,65c1,47,4,95,13,142c8,48,23,92,44,135c22,42,50,81,83,115c34,34,72,62,115,83c43,22,87,36,135,44c47,8,95,11,142,13c22,1,44,1,65,1c26,0,52,0,77,0h809c26,0,52,0,77,0c22,0,44,0,65-1c47-1,95-4,142-13c48-8,92-23,135-44c42-22,81-50,115-83c34-34,62-72,83-115c22-43,36-87,44-135c8-47,11-95,13-142c1-22,1-44,1-65c0-26,0-52,0-77V676z"
                />
                <path d="M806,1767V762H764L508,932v43l253-166h3v958H806z" />
                <path d="M1056,762v39h552v3l-443,964h47l440-964v-41H1056z" />
                <path
                  fill="#FF0000"
                  d="M393,565V348h1l86,195l28,0l86-195h1v217h28V277h-30L494,508h-1l-99-231h-30v288H393z"
                />
                <path
                  fill="#FF0000"
                  d="M778,341c-60,0-94,44-94,103v22c0,60,33,103,94,103c60,0,93-44,93-103v-22C871,384,838,341,778,341z M778,368c39,0,62,29,62,77v19c0,48-23,77-62,77c-40,0-62-30-62-77v-19C715,397,738,368,778,368z"
                />
                <path
                  fill="#FF0000"
                  d="M929,565h31V430c0-32,17-61,58-61c35,0,57,21,57,59v137h31v-142c0-54-34-83-80-83c-36,0-57,19-65,34h-1v-30h-31V565z"
                />
                <path
                  fill="#FF0000"
                  d="M1248,340c-55,0-88,43-88,103v23c0,61,31,103,88,103c32,0,54-16,66-38h1v34h29V262h-31v114h-1C1302,357,1279,340,1248,340z M1251,368c39,0,63,31,63,76v21c0,48-23,76-63,76c-35,0-61-26-61-76v-20C1191,393,1217,368,1251,368z"
                />
                <path
                  fill="#FF0000"
                  d="M1537,536h1v29h30V412c0-45-33-71-79-71c-51,0-78,27-80,65h29c3-23,19-38,50-38c31,0,50,17,50,48v24h-60c-50,0-77,25-77,63c0,40,29,67,72,67C1505,569,1526,554,1537,536z M1479,542c-25,0-48-13-48-41c0-22,14-37,46-37h59v27C1537,521,1512,542,1479,542z"
                />
                <path
                  fill="#FF0000"
                  d="M1796,344h-33l-63,185h-1l-63-185h-34l83,224l-4,14c-7,23-18,36-44,36c-5,0-13-1-16-1v26c6,1,14,2,21,2c43,0,58-30,69-61l6-17L1796,344z"
                />
              </svg>
              <span>Apple</span>
            </a>
          </div>
        </section>
      </main>

      <footer>
        <p>
          Cr√©√© avec ‚ù§Ô∏è pour les √©tudiants d'Assas par
          <a
            href="https://github.com/tomspace900"
            target="_blank"
            style="color: #667eea; text-decoration: none; font-weight: 500"
            >Thomas Gendron</a
          >
        </p>
        <p style="margin-top: 10px">
          <a href="https://github.com/tomspace900/assas-cal-exporter" target="_blank"
            >Voir le code sur GitHub</a
          >
        </p>
      </footer>
    </div>

    <script>
      // Bookmarklet code injected at build time
      const BOOKMARKLET_CODE = "javascript:(function(){function e(e){return e?e.replace(/[-:]/g,\"\").replace(\"T\",\"T\"):\"\"}function t(e){return e?e.replace(/\\\\/g,\"\\\\\\\\\").replace(/;/g,\"\\\\;\").replace(/,/g,\"\\\\,\").replace(/\\n/g,\"\\\\n\"):\"\"}function n(e){if(e.length<=75)return e;const t=[];let n=e;for(t.push(n.substring(0,75)),n=n.substring(75);n.length>0;)t.push(\" \"+n.substring(0,74)),n=n.substring(74);return t.join(\"\\r\\n\")}function r(){const e=new Date;return`${e.getUTCFullYear()}${String(e.getUTCMonth()+1).padStart(2,\"0\")}${String(e.getUTCDate()).padStart(2,\"0\")}T${String(e.getUTCHours()).padStart(2,\"0\")}${String(e.getUTCMinutes()).padStart(2,\"0\")}${String(e.getUTCSeconds()).padStart(2,\"0\")}Z`}function o(e){if(!e)return\"\";const t={\"&#233;\":\"√©\",\"&#232;\":\"√®\",\"&#234;\":\"√™\",\"&#224;\":\"√†\",\"&#226;\":\"√¢\",\"&#231;\":\"√ß\",\"&#244;\":\"√¥\",\"&#249;\":\"√π\",\"&#251;\":\"√ª\",\"&#239;\":\"√Ø\",\"&amp;\":\"&\",\"&lt;\":\"<\",\"&gt;\":\">\",\"&quot;\":'\"',\"&#39;\":\"'\"};let n=e;for(const[e,r]of Object.entries(t))n=n.replace(new RegExp(e,\"g\"),r);return n}function s(e){if(!e)return\"\";return{\"Cours magistral\":\"CM\",\"Travaux dirig√©s\":\"TD\",\"Travaux pratiques\":\"TP\",\"Conf√©rence\":\"Conf\",\"S√©minaire\":\"S√©m\",Examen:\"Exam\"}[e]||e}function a(e){if(!e)return e;const t=e.match(/^(\\d+)/);return t?t[1]:e.toUpperCase().includes(\"OPTION\")?\"OPTION\":e.trim()}function parseDescription(e){if(!e)return{category:null,module:null,staff:null,group:null,room:null};let t=e.replace(/<br\\s*\\/?>/gi,\"\\n\").replace(/\\r\\n/g,\"\\n\").replace(/\\r/g,\"\\n\");t=o(t);const n=t.split(\"\\n\").map(e=>e.trim()).filter(e=>e.length>0),r={category:null,module:null,staff:null,group:null,room:null};if(0===n.length)return r;r.category=n[0],n.length>1&&(r.module=n[1]);const s=/^Salle\\s+(.+)$/i,l=/^Groupe\\s+(.+)$/i,c=/^([A-Z√Ä-√ñ][A-Z√Ä-√ñ\\s-]+),\\s*([A-Z√Ä-√ña-z√†-√∂][a-z√†-√∂\\s-]+)$/,i=/(.+?)\\s*-\\s*Groupe\\s+(\\d+)/i;for(let e=2;e<n.length;e++){const t=n[e],o=t.match(s);if(o){r.room=o[1].trim();continue}const u=t.match(i);if(u){r.staff||(r.staff=u[1].trim()),r.group||(r.group=u[2].trim());continue}const d=t.match(l);if(d){const e=a(d[1].trim());r.group=e;continue}t.match(c)?r.staff=t.trim():/^[A-Z√Ä-√ña-z√†-√∂\\s-]+$/.test(t)&&(t===t.toUpperCase()||t.length<15?r.group||(r.group=t.trim()):r.staff||(r.staff=t.trim()))}return r}function l(e,t){const n=[];return e.module&&n.push(`Module: ${e.module}`),e.staff&&n.push(`Intervenant: ${e.staff}`),e.group&&n.push(`Groupe: ${e.group}`),e.room&&n.push(`Salle: ${e.room}`),t.department&&n.push(`D√©partement: ${t.department}`),t.modules&&t.modules.length>0&&n.push(`Code: ${t.modules.join(\", \")}`),n.join(\"\\n\")}function generateIcs(e){const t=[];t.push(\"BEGIN:VCALENDAR\"),t.push(\"VERSION:2.0\"),t.push(\"PRODID:-//Assas//Calendar Exporter//EN\"),t.push(\"CALSCALE:GREGORIAN\"),t.push(\"METHOD:PUBLISH\"),t.push(\"X-WR-CALNAME:Assas Calendar\"),t.push(\"X-WR-TIMEZONE:Europe/Paris\");for(const n of e){const e=c(n);t.push(e)}return t.push(\"END:VCALENDAR\"),t.join(\"\\r\\n\")}function c(o){const a=[];a.push(\"BEGIN:VEVENT\");const c=t(o.id);a.push(n(`UID:${c}`)),a.push(`DTSTAMP:${r()}`);const i=e(o.start);a.push(`DTSTART:${i}`);const u=e(o.end);a.push(`DTEND:${u}`);const d=s(o.eventCategory)||\"Cours\";let p=d;o.parsed&&o.parsed.module&&(p=`${d} - ${o.parsed.module}`);const f=t(p);a.push(n(`SUMMARY:${f}`));const g=t(l(o.parsed||{},o));a.push(n(`DESCRIPTION:${g}`));let m=\"\";if(o.parsed&&o.parsed.room?m=o.parsed.room:o.sites&&o.sites.length>0&&(m=o.sites.join(\", \")),m){const e=t(m);a.push(n(`LOCATION:${e}`))}if(o.eventCategory){const e=t(o.eventCategory);a.push(n(`CATEGORIES:${e}`))}return a.push(\"STATUS:CONFIRMED\"),a.push(\"TRANSP:OPAQUE\"),a.push(\"END:VEVENT\"),a.join(\"\\r\\n\")}function extractStudentId(){try{const e=document.querySelector(\".logInOrOut\");if(e){const t=e.querySelector(\".small\");if(t&&t.textContent){const e=t.textContent.trim().match(/\\d+/);if(e)return console.log(\"[Assas Exporter] Found student ID in navbar:\",e[0]),e[0]}}}catch(e){console.log(\"[Assas Exporter] Could not extract from navbar:\",e)}try{const e=document.querySelectorAll(\"*\");for(const t of e){const e=(t.textContent||\"\").match(/[-\\s](\\d{7})/);if(e)return console.log(\"[Assas Exporter] Found student ID in DOM:\",e[1]),e[1]}}catch(e){console.log(\"[Assas Exporter] Could not scan DOM:\",e)}const e=window.location.href,t=e.match(/federationIds(?:%5B%5D|\\[\\])=([^&]+)/);if(t)return console.log(\"[Assas Exporter] Found student ID in query params:\",t[1]),t[1];const n=e.match(/#.*federationIds(?:%5B%5D|\\[\\])=([^&]+)/);if(n)return console.log(\"[Assas Exporter] Found student ID in hash fragment:\",n[1]),n[1];const r=e.match(/[?&]id=([^&]+)/);if(r)return console.log(\"[Assas Exporter] Found student ID in id param:\",r[1]),r[1];const o=e.match(/\\/student\\/(\\d+)/);return o?(console.log(\"[Assas Exporter] Found student ID in path:\",o[1]),o[1]):(console.log(\"[Assas Exporter] Could not extract student ID automatically\"),null)}function promptDateRange(){const e=new Date,t=e.getFullYear(),n=e.getMonth()+1>=9?t:t-1,r=`${n}-09-01`,o=`${n+1}-08-31`,s=new Date(r),a=new Date(o),l=`${s.getDate()} ${i(s.getMonth())} ${s.getFullYear()}`,c=`${a.getDate()} ${i(a.getMonth())} ${a.getFullYear()}`,u=prompt(`üìÖ DATE DE D√âBUT\\n\\nFormat : ANN√âE-MOIS-JOUR (YYYY-MM-DD)\\n\\nExemple : (${l}) ‚Üí ${r}\\nExemple : (8 juin 2025) ‚Üí 2025-06-08\\n\\nEntre la date de d√©but :`,r);if(!u)return null;const d=prompt(`üìÖ DATE DE FIN\\n\\nFormat : ANN√âE-MOIS-JOUR (YYYY-MM-DD)\\n\\nExemple : (${c}) ‚Üí ${o}\\nExemple : (31 ao√ªt 2026) ‚Üí 2026-08-31\\n\\nEntre la date de fin :`,o);return d?/^\\d{4}-\\d{2}-\\d{2}$/.test(u)&&/^\\d{4}-\\d{2}-\\d{2}$/.test(d)?{startDate:u,endDate:d}:(alert(\"‚ùå Format de date invalide !\\n\\nUtilise le format : ANN√âE-MOIS-JOUR\\nExemple : 2025-09-01 pour le 1er septembre 2025\"),null):null}function i(e){return[\"janvier\",\"f√©vrier\",\"mars\",\"avril\",\"mai\",\"juin\",\"juillet\",\"ao√ªt\",\"septembre\",\"octobre\",\"novembre\",\"d√©cembre\"][e]}async function u(e){const t=new URLSearchParams({\"federationIds[]\":e,resType:\"104\"});try{const e=await fetch(\"https://celcat-web.u-paris2.fr/calendar/Home/LoadDisplayNames\",{method:\"POST\",headers:{\"Content-Type\":\"application/x-www-form-urlencoded\"},body:t.toString(),credentials:\"include\"});if(!e.ok)return console.log(\"[Assas Exporter] Could not fetch student name\"),null;const n=await e.json();if(n&&n.length>0&&n[0].displayName){const e=n[0].displayName.split(\",\");if(e.length>=2){const t=e[1].trim();return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}}}catch(e){console.log(\"[Assas Exporter] Error fetching student name:\",e)}return null}async function fetchCalendarData(e,t,n){const r=new URLSearchParams({start:t,end:n,resType:\"104\",calView:\"agendaDay\",\"federationIds[]\":e});console.log(\"[Assas Exporter] Fetching calendar data...\",{studentId:e,startDate:t,endDate:n});const o=await fetch(\"https://celcat-web.u-paris2.fr/calendar/Home/GetCalendarData\",{method:\"POST\",headers:{\"Content-Type\":\"application/x-www-form-urlencoded\"},body:r.toString(),credentials:\"include\"});if(!o.ok)throw new Error(`Erreur API: ${o.status} ${o.statusText}`);const s=await o.json();return console.log(\"[Assas Exporter] Fetched events:\",s.length),s}function d(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||navigator.maxTouchPoints&&navigator.maxTouchPoints>2}async function downloadIcsFile(e,t=\"assas-calendar.ics\"){const n=new Blob([e],{type:\"text/calendar;charset=utf-8\"});if(d()&&navigator.share&&navigator.canShare)try{const e=new File([n],t,{type:\"text/calendar;charset=utf-8\"});if(navigator.canShare({files:[e]}))return await navigator.share({files:[e],title:\"Calendrier Assas\",text:\"Importer dans ton calendrier\"}),console.log(\"[Assas Exporter] File shared successfully\"),void showStatus(\"üìÖ Fichier partag√© ! Choisis ton app calendrier\",\"success\")}catch(e){\"AbortError\"===e.name?(console.log(\"[Assas Exporter] User cancelled share, falling back to download\"),showStatus(\"üì• T√©l√©chargement du fichier...\",\"info\")):console.log(\"[Assas Exporter] Share failed, falling back to download:\",e)}const r=URL.createObjectURL(n),o=document.createElement(\"a\");o.href=r,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(r),100),console.log(\"[Assas Exporter] File download triggered:\",t)}function showStatus(e,t=\"info\"){const n={info:\"#2196f3\",success:\"#4caf50\",error:\"#f44336\"},r=document.createElement(\"div\");r.textContent=e,r.style.cssText=`\\n    position: fixed;\\n    top: 20px;\\n    right: 20px;\\n    padding: 15px 20px;\\n    background: ${n[t]||n.info};\\n    color: white;\\n    border-radius: 4px;\\n    z-index: 999999;\\n    font-family: sans-serif;\\n    font-size: 14px;\\n    box-shadow: 0 2px 8px rgba(0,0,0,0.3);\\n    max-width: 300px;\\n  `,document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},3e3)}\"undefined\"!=typeof module&&module.exports,\"undefined\"!=typeof module&&module.exports,async function(){\"use strict\";try{console.log(\"[Assas Exporter] Starting calendar export...\"),showStatus(\"Recherche de ton ID...\",\"info\");let e=extractStudentId();if(!e){if(e=prompt(\"üéì ID √âTUDIANT\\n\\nTon ID n'a pas pu √™tre d√©tect√© automatiquement.\\n\\nO√π le trouver ?\\n‚Ä¢ En haut √† droite de la page CELCAT\\n‚Ä¢ √Ä c√¥t√© de \\\"Log Out\\\" (exemple: - 2401012)\\n‚Ä¢ C'est un nombre √† 7 chiffres\\n\\nEntre ton ID √©tudiant :\",\"\"),!e||!e.trim())return void showStatus(\"Export annul√©\",\"error\");e=e.trim()}console.log(\"[Assas Exporter] Using student ID:\",e);let t=null;try{t=await u(e),t&&(console.log(\"[Assas Exporter] Hello\",t+\"!\"),showStatus(`Salut ${t} ! üëã`,\"success\"),await new Promise(e=>setTimeout(e,1500)))}catch(e){console.log(\"[Assas Exporter] Could not fetch name:\",e)}const n=t||\"\";showStatus(n?`OK ${n}, choisis tes dates...`:\"Choisis tes dates...\",\"info\");const r=promptDateRange();if(!r)return void showStatus(\"Export annul√©\",\"error\");const{startDate:o,endDate:s}=r;let a;console.log(\"[Assas Exporter] Date range:\",o,\"to\",s),showStatus(n?`R√©cup de ton planning ${n}...`:\"R√©cup√©ration du planning...\",\"info\");try{a=await fetchCalendarData(e,o,s)}catch(e){return console.error(\"[Assas Exporter] API Error:\",e),void showStatus(`Erreur API: ${e.message}`,\"error\")}if(!a||0===a.length)return void showStatus(\"Aucun √©v√©nement trouv√© pour cette p√©riode ü§î\",\"error\");console.log(`[Assas Exporter] Fetched ${a.length} events`),showStatus(`Analyse de ${a.length} √©v√©nements...`,\"info\");const l=a.map(e=>({...e,parsed:parseDescription(e.description)}));let c;console.log(`[Assas Exporter] Processing ${l.length} events`),showStatus(\"G√©n√©ration du fichier...\",\"info\");try{c=generateIcs(l)}catch(e){return console.error(\"[Assas Exporter] ICS Generation Error:\",e),void showStatus(`Erreur: ${e.message}`,\"error\")}const i=`assas-calendar-${o}-${s}.ics`;await downloadIcsFile(c,i);const d=l.length;showStatus(n?`C'est bon ${n} ! ${d} cours export√©s üéâ`:`‚úì ${d} cours export√©s üéâ`,\"success\"),console.log(\"[Assas Exporter] Export completed successfully!\"),console.log(`[Assas Exporter] File: ${i}`),console.log(`[Assas Exporter] Events: ${d}`)}catch(e){console.error(\"[Assas Exporter] Unexpected error:\",e),showStatus(`Erreur: ${e.message}`,\"error\")}}();})();";

      // Detect if user is on mobile/tablet
      function isMobile() {
        return (
          /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ||
          (navigator.maxTouchPoints && navigator.maxTouchPoints > 2)
        );
      }

      // Inject bookmarklet href dynamically to avoid HTML escaping issues
      document.addEventListener("DOMContentLoaded", function () {
        const link = document.getElementById("bookmarklet-link");
        if (link) {
          link.href = BOOKMARKLET_CODE;
        }

        // Show mobile-specific instructions if on mobile
        if (isMobile()) {
          const desktopInstructions = document.getElementById("desktop-instructions");
          const mobileInstructions = document.getElementById("mobile-instructions");
          const mobileStep2 = document.getElementById("mobile-step-2");
          const mobileStep3 = document.getElementById("mobile-step-3");
          const desktopStep2 = document.getElementById("desktop-step-2");
          const helpSection = document.querySelector(".help");

          if (desktopInstructions) desktopInstructions.style.display = "none";
          if (mobileInstructions) mobileInstructions.style.display = "block";
          if (mobileStep2) mobileStep2.style.display = "block";
          if (mobileStep3) mobileStep3.style.display = "block";
          if (desktopStep2) desktopStep2.style.display = "none";
          if (helpSection) helpSection.style.display = "none";

          // Adapt import section for mobile
          const importDesktopText = document.getElementById("import-desktop-text");
          const importMobileText = document.getElementById("import-mobile-text");
          const calendarLinks = document.getElementById("calendar-links");

          if (importDesktopText) importDesktopText.style.display = "none";
          if (importMobileText) importMobileText.style.display = "block";
          if (calendarLinks) calendarLinks.style.display = "none";
        }
      });

      function copyCode(event) {
        const button = event.target;
        const originalText = button.textContent;
        const originalBg = button.style.background;
        const originalColor = button.style.color;

        function showSuccess() {
          button.textContent = "‚úÖ Copi√© !";
          button.style.background = "#28a745";
          button.style.color = "white";

          setTimeout(() => {
            button.textContent = originalText;
            button.style.background = originalBg || "";
            button.style.color = originalColor || "";
          }, 2000);
        }

        function showError() {
          alert("Erreur lors de la copie. S√©lectionne le texte manuellement.");
        }

        // Use modern Clipboard API (works on mobile)
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(BOOKMARKLET_CODE).then(showSuccess).catch(showError);
        } else {
          // Fallback for older browsers
          const textarea = document.getElementById("bookmarklet-code");
          if (textarea) {
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            try {
              document.execCommand("copy");
              showSuccess();
            } catch (err) {
              showError();
            }
          } else {
            showError();
          }
        }
      }
    </script>
  </body>
</html>
